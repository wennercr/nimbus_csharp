trigger:
- main

# Self-hosted agent on your PC
pool:
  name: Default                # your agent pool name
  demands:
    - Agent.OS -equals Windows_NT

variables:
  SUITE_NAME: 'SampleSmoke'
  BROWSER: 'chrome'
  HEADLESS: 'true'
  GROUPS: 'smoke,login'        # comma list -> OR filter (smoke OR login)
  THREADS: '3'
  GRID_URL: 'http://localhost:4444'

steps:
- checkout: self

- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '9.0.x'

- powershell: dotnet restore
  displayName: Restore

- powershell: dotnet build --configuration Release --no-restore
  displayName: Build

# Start Selenium Grid (requires Docker Desktop running)
- powershell: |
    docker rm -f selenium-grid 2>$null
    docker run -d -p 4444:4444 --name selenium-grid selenium/standalone-chrome:latest | Out-Null
    # simple wait; you can replace with a /status check later
    Start-Sleep -Seconds 12
  displayName: Start Selenium Grid

# Run tests with multi-category filter (smoke,login -> TestCategory=smoke|TestCategory=login)
- powershell: |
    $raw = "$(GROUPS)".Replace(" ", "")
    $filter = ""
    if ($raw) {
      $parts = $raw -split ","
      foreach ($p in $parts) {
        if (-not [string]::IsNullOrWhiteSpace($p)) {
          if ($filter) { $filter += "|TestCategory=$p" } else { $filter = "TestCategory=$p" }
        }
      }
    }
    Write-Host "Filter: $filter"
    $filterArg = ""
    if ($filter) { $filterArg = "--filter `"$filter`"" }

    dotnet test src/Nimbus.Testing/Nimbus.Testing.csproj `
      --configuration Release `
      --no-build `
      --logger "trx;LogFileName=test_results.trx" `
      $filterArg `
      --results-directory target/test-results `
      -- `
      "NUnit.NumberOfTestWorkers=$(THREADS)" `
      "TestRunParameters.Parameter(name=`"testSuiteName`", value=`"$(SUITE_NAME)`")" `
      "TestRunParameters.Parameter(name=`"browser`", value=`"$(BROWSER)`")" `
      "TestRunParameters.Parameter(name=`"headless`", value=`"$(HEADLESS)`")" `
      "TestRunParameters.Parameter(name=`"remote`", value=`"true`")" `
      "TestRunParameters.Parameter(name=`"gridUrl`", value=`"$(GRID_URL)`")"
  displayName: Run Nimbus tests

# Publish TRX so results show in Azure's Tests tab
- task: PublishTestResults@2
  condition: always()
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: 'target/test-results/**/*.trx'
    failTaskOnFailedTests: false
  displayName: Publish TRX to Azure

# Cleanup container
- powershell: docker rm -f selenium-grid 2>$null
  displayName: Stop Selenium Grid
  condition: always()

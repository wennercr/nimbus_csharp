trigger:
- main

# Self-hosted agent on your PC
pool:
  name: Default                # your agent pool name
  demands:
    - Agent.OS -equals Windows_NT

variables:
  SUITE_NAME: 'SampleSmoke'
  BROWSER: 'chrome'
  HEADLESS: 'true'
  GROUPS: 'smoke'        # comma list -> OR filter (smoke OR login)
  THREADS: '3'
  GRID_URL: 'http://localhost:4444'

steps:
- checkout: self

- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '9.0.x'

- powershell: dotnet restore
  displayName: Restore

- powershell: dotnet build --configuration Release --no-restore
  displayName: Build

# Start Selenium Grid (requires Docker Desktop running)
- powershell: |
    $ErrorActionPreference = 'Continue'
    $ProgressPreference = 'SilentlyContinue'

    # Remove old container if it exists
    $existing = (docker ps -aq -f "name=^selenium-grid$")
    if ($existing) {
      Write-Host "Removing existing selenium-grid container $existing"
      docker rm -f selenium-grid | Out-Null
    } else {
      Write-Host "No existing selenium-grid container"
    }

    # Diagnostics (optional)
    docker version
    docker info

    # Start fresh container
    docker run --pull=always -d -p 4444:4444 --shm-size=2g --name selenium-grid selenium/standalone-chrome:latest | Out-Null

    # Wait for Grid readiness
    Write-Host "Waiting for Selenium Grid to be ready on http://localhost:4444/status ..."
    $max = 30
    for ($i = 1; $i -le $max; $i++) {
      try {
        $resp = curl.exe -s http://localhost:4444/status | ConvertFrom-Json
        if ($resp.value.ready -eq $true) {
          Write-Host "Selenium Grid is ready."
          exit 0
        }
      } catch { }
      Start-Sleep -Seconds 2
      Write-Host "Attempt $($i)/$($max): not ready yet..."
    }
    Write-Error "Selenium Grid did not become ready in time."
    exit 1
  displayName: Start Selenium Grid



# Run tests with multi-category filter (smoke,login -> TestCategory=smoke|TestCategory=login)
- powershell: |
    $ErrorActionPreference = 'Stop'

    # Build OR filter like: TestCategory=smoke|TestCategory=login
    $raw = "$(GROUPS)".Replace(" ", "")
    $parts = $raw -split ',' | Where-Object { $_ }
    $filter = ($parts | ForEach-Object { "TestCategory=$_" }) -join '|'

    $runsetPath = 'nimbus.runsettings'
    if (-not (Test-Path $runsetPath)) { throw "Runsettings not found at $runsetPath" }

    if ($filter) {
      # Load XML and inject/replace <TestCaseFilter>
      [xml]$doc = Get-Content -Raw $runsetPath
      $rc = $doc.RunSettings.RunConfiguration
      if (-not $rc) {
        $rc = $doc.CreateElement('RunConfiguration')
        $doc.RunSettings.AppendChild($rc) | Out-Null
      }
      if ($rc.TestCaseFilter) {
        $rc.TestCaseFilter = $filter
      } else {
        $node = $doc.CreateElement('TestCaseFilter')
        $node.InnerText = $filter
        $rc.AppendChild($node) | Out-Null
      }
      $doc.Save($runsetPath)
    }

    # Ensure results dir exists
    New-Item -ItemType Directory -Force -Path 'target/test-results' | Out-Null

    # Run tests using the runsettings file
    & dotnet test `
      --configuration Release `
      --no-build `
      --logger "trx;LogFileName=test_results.trx" `
      --results-directory target/test-results `
      --settings $runsetPath `
      src/Nimbus.Testing/Nimbus.Testing.csproj

    exit $LASTEXITCODE
  displayName: Run Nimbus tests



# Publish TRX so results show in Azure's Tests tab
- task: PublishTestResults@2
  condition: always()
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: 'target/test-results/**/*.trx'
    failTaskOnFailedTests: false
  displayName: Publish TRX to Azure

- task: PublishAllureReport@1
  displayName: "Publish Allure report"
  condition: always()
  inputs:
    # point at the folder that contains *.json, *.txt, attachments/ from Allure adapter
    testResultsDir: "src/Nimbus.Testing/bin/Release/net9.0/target/allure-results"
    reportName: "Nimbus â€“ $(Build.BuildNumber)"

# Cleanup container
- powershell: docker rm -f selenium-grid 2>$null
  displayName: Stop Selenium Grid
  condition: always()

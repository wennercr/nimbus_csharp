stages:
  - test
  - report

variables:
  SUITE_NAME: "SampleSmoke"
  BROWSER: "chrome"
  HEADLESS: "true"
  GROUPS: "smoke"
  THREADS: "3"
  GRID_URL: "http://selenium-hub:4444/wd/hub"
  SELENOID: "false"
  ALLURE_RESULTS_DIR: "src/Nimbus.Testing/bin/Release/net9.0/allure-results"
  ALLURE_REPORT_DIR: "target/allure-report"

test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  # Uncomment below to use Selenoid instead of Selenium Grid
  # services:
  #   - name: aerokube/selenoid:latest-release
  #     alias: selenoid
  #     entrypoint: [""]
  #     command: ["-limit", "${THREADS}", "-container-network", "bridge", "-retry-count", "1"]
  services:
    - name: selenium/hub:4.18.0
      alias: selenium-hub
    - name: selenium/node-chrome:4.18.0
      alias: chrome
      entrypoint: [""]
      command: ["--SE_EVENT_BUS_HOST=selenium-hub", "--SE_EVENT_BUS_PUBLISH_PORT=4442", "--SE_EVENT_BUS_SUBSCRIBE_PORT=4443"]
    - name: selenium/node-edge:4.18.0
      alias: edge
      entrypoint: [""]
      command: ["--SE_EVENT_BUS_HOST=selenium-hub", "--SE_EVENT_BUS_PUBLISH_PORT=4442", "--SE_EVENT_BUS_SUBSCRIBE_PORT=4443"]

  script:
    - rm -rf "${ALLURE_RESULTS_DIR}" "${ALLURE_REPORT_DIR}"
    - mkdir -p "${ALLURE_RESULTS_DIR}" "${ALLURE_REPORT_DIR}"

    # Build VSTest filter like: TestCategory=a|TestCategory=b|TestCategory=c
    - |
      RAW="${GROUPS}"
      RAW="${RAW// /}"
      FILTER=""
      if [ -n "${RAW}" ]; then
        IFS=',' read -ra PARTS <<< "${RAW}"
        for p in "${PARTS[@]}"; do
          [ -z "$p" ] && continue
          if [ -z "${FILTER}" ]; then
            FILTER="TestCategory=${p}"
          else
            FILTER="${FILTER}|TestCategory=${p}"
          fi
        done
      fi
      echo "Computed filter: ${FILTER:-<none>}" > filter.txt

    - dotnet restore
    - dotnet build --configuration Release --no-restore

    - |
      FILTER=$(cat filter.txt)
      dotnet test \
        --configuration Release \
        --no-build \
        --logger "trx;LogFileName=test_results.trx" \
        ${FILTER:+--filter "${FILTER}"} \
        --results-directory target/test-results \
        -- \
        "NUnit.NumberOfTestWorkers=${THREADS}" \
        "TestRunParameters.Parameter(name=\"testSuiteName\", value=\"${SUITE_NAME}\")" \
        "TestRunParameters.Parameter(name=\"browser\", value=\"${BROWSER}\")" \
        "TestRunParameters.Parameter(name=\"headless\", value=\"${HEADLESS}\")" \
        "TestRunParameters.Parameter(name=\"remote\", value=\"true\")" \
        "TestRunParameters.Parameter(name=\"gridUrl\", value=\"${GRID_URL}\")" \
        "TestRunParameters.Parameter(name=\"isSelenoid\", value=\"${SELENOID}\")"

  artifacts:
    when: always
    name: "allure-results-${CI_COMMIT_SHORT_SHA}"
    paths:
      - target/test-results
      - ${ALLURE_RESULTS_DIR}
    expire_in: 1 week

report:
  stage: report
  image: "ghcr.io/allure-framework/allure-cli:2.29.0"
  script:
    - |
      RESULTS="${ALLURE_RESULTS_DIR}"
      REPORT_ROOT="${ALLURE_REPORT_DIR}"
      VERSIONED_DIR="${REPORT_ROOT}/${CI_PIPELINE_ID}"
      LATEST_DIR="${REPORT_ROOT}/latest"

      allure generate "${RESULTS}" -o "${VERSIONED_DIR}" --clean

      rm -rf "${LATEST_DIR}"
      mkdir -p "${REPORT_ROOT}"
      cp -r "${VERSIONED_DIR}" "${LATEST_DIR}"

      if [ -f "${LATEST_DIR}/index.html" ]; then
        sed -i "s#app.js#app.js?v=${CI_PIPELINE_ID}#g" "${LATEST_DIR}/index.html"
        sed -i "s#styles.css#styles.css?v=${CI_PIPELINE_ID}#g" "${LATEST_DIR}/index.html"
        sed -i "1i <meta http-equiv=\"Cache-Control\" content=\"no-cache, no-store, must-revalidate\"/>" "${LATEST_DIR}/index.html"
      fi

      cat > "${REPORT_ROOT}/index.html" <<HTML
      <!doctype html><meta charset="utf-8">
      <meta http-equiv="refresh" content="0; url=./latest/?t=${CI_PIPELINE_ID}">
      <title>Allure Report</title>
      <a href="./latest/?t=${CI_PIPELINE_ID}">Go to latest report</a>
      HTML

      touch "${REPORT_ROOT}/.nojekyll"

      echo "Publish dir contents (2 levels):"
      find "${REPORT_ROOT}" -maxdepth 2 -print | sort

  artifacts:
    when: always
    name: "allure-report-${CI_COMMIT_SHORT_SHA}"
    paths:
      - ${ALLURE_REPORT_DIR}
    expire_in: 2 weeks
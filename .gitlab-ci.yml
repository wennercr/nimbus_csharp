stages:
  - test
  - report
  - deploy

variables:
  SUITE_NAME: "SampleSmoke"
  BROWSER: "chrome"
  HEADLESS: "true"
  GROUPS: "Smoke"
  THREADS: "1"
  GRID_URL: "http://selenium-hub:4444/wd/hub"
  SELENOID: "false"
  ALLURE_RESULTS_DIR: "src/Nimbus.Testing/bin/Release/net9.0/allure-results"
  ALLURE_REPORT_DIR: "target/allure-report"

test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:9.0

  services:
    - name: selenium/standalone-chrome:4.18.0
      alias: chrome
    - name: selenium/standalone-edge:4.18.0
      alias: edge

  script:
    - |
      echo "BROWSER is: ${BROWSER}"

      # Decide which standalone container URL to use based on BROWSER
      if [ "${BROWSER}" = "chrome" ]; then
        GRID_URL="http://chrome:4444"
      elif [ "${BROWSER}" = "edge" ]; then
        GRID_URL="http://edge:4444"
      else
        echo "Unsupported BROWSER value: '${BROWSER}'. Use 'chrome' or 'edge'."
        exit 1
      fi

      echo "Using GRID_URL=${GRID_URL}"

      echo "Waiting for ${BROWSER} container to be ready..."
      for i in {1..30}; do
        STATUS_URL="${GRID_URL}/status"
        STATUS_RAW=$(curl -s "${STATUS_URL}" || true)
        echo "Raw status from ${STATUS_URL}: ${STATUS_RAW}"

        # Check for "ready": true with optional spaces
        if echo "${STATUS_RAW}" | grep -q '"ready"[[:space:]]*:[[:space:]]*true'; then
          echo "Selenium ${BROWSER} standalone is ready."
          break
        fi

        echo "Selenium ${BROWSER} standalone not ready yet (attempt ${i}/30)."
        sleep 2

        if [ "$i" -eq 30 ]; then
          echo "Selenium ${BROWSER} standalone did not become ready in time."
          exit 1
        fi
      done

      echo "Testing raw session creation against ${GRID_URL}..."

      curl -s -X POST "${GRID_URL}/session" \
        -H 'Content-Type: application/json' \
        -d '{
          "capabilities": {
            "alwaysMatch": {
              "browserName": "'"${BROWSER}"'"
            }
          }
        }' || echo "Session curl failed"

      # Clean / prepare Allure directories
      rm -rf "${ALLURE_RESULTS_DIR}" "${ALLURE_REPORT_DIR}"
      mkdir -p "${ALLURE_RESULTS_DIR}" "${ALLURE_REPORT_DIR}"

      # Build the NUnit filter from GROUPS
      RAW="${GROUPS}"
      RAW="${RAW// /}"
      FILTER=""
      if [ -n "${RAW}" ]; then
        IFS=',' read -ra PARTS <<< "${RAW}"
        for p in "${PARTS[@]}"; do
          [ -z "$p" ] && continue
          if [ -z "${FILTER}" ]; then
            FILTER="TestCategory=${p}"
          else
            FILTER="${FILTER}|TestCategory=${p}"
          fi
        done
      fi
      echo "Computed filter: ${FILTER:-<none>}"

      dotnet restore
      dotnet build --configuration Release --no-restore

      dotnet test src/Nimbus.Testing/Nimbus.Testing.csproj \
        --configuration Release \
        --no-build \
        --logger "trx;LogFileName=test_results.trx" \
        ${FILTER:+--filter "${FILTER}"} \
        --results-directory target/test-results \
        -- \
        "NUnit.NumberOfTestWorkers=${THREADS}" \
        "TestRunParameters.Parameter(name=\"testSuiteName\", value=\"${SUITE_NAME}\")" \
        "TestRunParameters.Parameter(name=\"browser\", value=\"${BROWSER}\")" \
        "TestRunParameters.Parameter(name=\"headless\", value=\"${HEADLESS}\")" \
        "TestRunParameters.Parameter(name=\"remote\", value=\"true\")" \
        "TestRunParameters.Parameter(name=\"gridUrl\", value=\"${GRID_URL}\")" \
        "TestRunParameters.Parameter(name=\"isSelenoid\", value=\"${SELENOID}\")"

  artifacts:
    when: always
    name: "allure-results-${CI_COMMIT_SHORT_SHA}"
    paths:
      - target/test-results
      - ${ALLURE_RESULTS_DIR}
    expire_in: 1 week

report:
  stage: report
  image: ubuntu:22.04
  before_script:
    - apt-get update && apt-get install -y curl unzip sudo wget openjdk-11-jre
    - export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
    - export PATH=$JAVA_HOME/bin:$PATH
    - |
      LATEST_VERSION=$(curl -s https://api.github.com/repos/allure-framework/allure2/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
      echo "Latest Allure version: $LATEST_VERSION"
      wget "https://github.com/allure-framework/allure2/releases/download/$LATEST_VERSION/allure-$LATEST_VERSION.zip" -O allure.zip
      unzip allure.zip -d allure-cli
      sudo mv "allure-cli/allure-$LATEST_VERSION" /opt/allure
      sudo ln -s /opt/allure/bin/allure /usr/bin/allure
      allure --version
  script:
    - |
      RESULTS="${ALLURE_RESULTS_DIR}"
      REPORT_ROOT="${ALLURE_REPORT_DIR}"
      VERSIONED_DIR="${REPORT_ROOT}/${CI_PIPELINE_ID}"
      LATEST_DIR="${REPORT_ROOT}/latest"

      allure generate "${RESULTS}" -o "${VERSIONED_DIR}" --clean

      rm -rf "${LATEST_DIR}"
      mkdir -p "${REPORT_ROOT}"
      cp -r "${VERSIONED_DIR}" "${LATEST_DIR}"

      if [ -f "${LATEST_DIR}/index.html" ]; then
        sed -i "s#app.js#app.js?v=${CI_PIPELINE_ID}#g" "${LATEST_DIR}/index.html"
        sed -i "s#styles.css#styles.css?v=${CI_PIPELINE_ID}#g" "${LATEST_DIR}/index.html"
        sed -i "1i <meta http-equiv=\"Cache-Control\" content=\"no-cache, no-store, must-revalidate\"/>" "${LATEST_DIR}/index.html"
      fi

      cat > "${REPORT_ROOT}/index.html" <<HTML
      <!doctype html><meta charset="utf-8">
      <meta http-equiv="refresh" content="0; url=./latest/?t=${CI_PIPELINE_ID}">
      <title>Allure Report</title>
      <a href="./latest/?t=${CI_PIPELINE_ID}">Go to latest report</a>
      HTML

      touch "${REPORT_ROOT}/.nojekyll"

      echo "Publish dir contents (2 levels):"
      find "${REPORT_ROOT}" -maxdepth 2 -print | sort

  artifacts:
    when: always
    name: "allure-report-${CI_COMMIT_SHORT_SHA}"
    paths:
      - ${ALLURE_REPORT_DIR}
    expire_in: 2 weeks

pages:
  stage: deploy
  script:
    - mkdir -p public
    - cp -r ${ALLURE_REPORT_DIR}/* public/
  artifacts:
    paths:
      - public
  only:
    - main